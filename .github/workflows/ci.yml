name: Continuous integration

on:
  pull_request:
  push:
    branches:
      - master

jobs:
  test-desktop:
    name: Build and test
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        args: [
          "--all-features",
        ]
    steps:

    - name: Cancel Previous Runs
      uses: styfle/cancel-workflow-action@a40b8845c0683271d9f53dfcb887a7e181d3918b # 0.9.1
      with:
        access_token: ${{ github.token }}

    - uses: actions/checkout@v2.4.0

    - uses: Swatinem/rust-cache@842ef286fff290e445b90b4002cc9807c3669641 # v1.3.0
      with:
        key: ${{ matrix.args }}

    - run: cargo test --workspace ${{ matrix.args }}
    - run: while cargo test ${{ matrix.args }} -p libp2p-autonat; do :; done
