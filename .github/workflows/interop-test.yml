name: Interoperability Testing
on:
  pull_request:
  push:
    branches:
      - "master"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  run-multidim-interop:
    name: Run multidimensional interoperability tests
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: recursive
      - uses: Swatinem/rust-cache@359a70e43a0bb8a13953b04a90f76428b4959bb6 # v2.2.0
        with:
          shared-key: interop-tests
          save-if: ${{ github.ref == 'refs/heads/master' }}
      - name: Install Protoc
        run: sudo apt-get install protobuf-compiler
      - name: Build image
        run: |
          cargo build --release -p interop-tests
          docker build -t rust-libp2p-head --build-arg=TEST_BINARY=target/release/ping . -f interop-tests/Dockerfile
      - uses: thomaseizinger/test-plans/.github/actions/run-interop-ping-test@composite-action
        with:
          test-filter: rust-libp2p-head
          extra-versions: ./interop-tests/ping-version.json
