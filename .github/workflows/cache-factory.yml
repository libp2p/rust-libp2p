name: Cache factory

on:
  push:
    branches:
      - master # Cache is only created on master branch.

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  make_cache:
    runs-on: ubuntu-latest
    steps:
      - name: Install Protoc
        uses: arduino/setup-protoc@64c0c85d18e984422218383b81c52f8b077404d3 # v1.1.2

      - uses: actions/checkout@v3

      - id: find-rust-versions
        run: |
          RUST_VERSIONS=$(cargo metadata --format-version=1 --no-deps | jq -c '.packages | map(.rust_version) | unique | del(..|nulls) | .[]')
          echo "versions=${RUST_VERSIONS}" >> $GITHUB_OUTPUT

      - name: Install Rust versions
        run: echo ${{ steps.find-rust-versions.outputs.versions }} | xargs -I '{}' rustup install '{}'

      - uses: Swatinem/rust-cache@359a70e43a0bb8a13953b04a90f76428b4959bb6 # v2.2.0
        with:
          shared-key: master-${{ hashFiles('**/Cargo.toml') }} # Other jobs can use this cache key to restore. They MUST NEVER save to this cache key.

      - name: Compile workspace with stable Rust
        run: |
          cargo +stable build --no-default-features --workspace
          cargo +stable build --all-features --workspace

      - name: Compile each crate on its MSRV with all features
        run: |
          cargo metadata --format-version=1 --no-deps | \
          jq -r '.packages[] | select(.rust_version != null) | "+\(.rust_version) build --all-features --package \(.name)"' |
          xargs -L 1 cargo

      - name: Compile each crate on its MSRV without features
        run: |
          cargo metadata --format-version=1 --no-deps | \
          jq -r '.packages[] | select(.rust_version != null) | "+\(.rust_version) build --package \(.name)"' |
          xargs -L 1 cargo

      - name: Render docs
        run: cargo +stable doc --all-features --workspace

      - name: Install tools
        run: |
          cargo install cargo-semver-checks --locked
